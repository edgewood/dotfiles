import logging
import os
import re
import sys
import yaml


_skips = {}


def load_skip_yaml(path=None, name=None):
    ''' load skips dict from named path, or a default path based on the name '''
    if path is None:
        assert name is not None
        base_dir = os.environ.get('XDG_CONFIG_DIR')
        if base_dir is None:
            base_dir = os.path.expanduser('~/.config/')
        path = os.path.join(base_dir, 'feed2exec', name.replace(' ', '_') + '.yaml')

    with open(path) as f:
        return yaml.safe_load(f.read())

def filter(*args, feed=None, item=None, **kwargs):
    '''the titlemulti filter will drop any feed item with a title matching

    Example::

      [NASA breaking news]
      url = https://www.nasa.gov/rss/dyn/breaking_news.rss
      filter = feed2exec.myplugins.titlemultifilter
      filter_args = /path/to/skips.yaml

    The above will process the feed items according to the global
    configuration, but will skip any item with a title that matches 
    one of the skips listed in the skip YAML file.  If filter_args
    isn't provided, it defaults to ~/.local/feed2exec/<feed title>.yaml,
    with spaces in the feed title replaced with underscores.
    '''
   
    global _skips
    if not _skips:
        _skips = load_skip_yaml(path=args[0] if args else None, name=feed['name'])

    log = _skips.get('log')
    if log is not None:
        logging.basicConfig(filename=log, level=logging.INFO)

    title = item.get('title', '')

    for skip in _skips.get('skips'):
        if re.search(skip, title, re.IGNORECASE):
            logging.info('Skipping, match on %s', skip)
            item['skip'] = True
            break
